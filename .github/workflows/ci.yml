name: ğŸ‰ Kali Dragon CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ§ª Test & Validate
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20, 21]
        exclude:
          # Skip Node.js 18 on Windows due to compatibility issues
          - os: windows-latest
            node-version: 18

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: ğŸ” Verify Setup Script
      run: |
        echo "ğŸ§ª Testing setup script permissions and basic syntax..."
        test -f setup.sh
        test -x setup.sh
        bash -n setup.sh
        echo "âœ… Setup script validation passed"

    - name: ğŸŒ Test Web Server
      run: |
        echo "ğŸš€ Starting web server test..."
        cd web-wizard
        
        # Test Node.js server syntax
        node -c server.js
        echo "âœ… Server.js syntax is valid"
        
        # Cross-platform server testing
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          echo "ğŸªŸ Testing on Windows..."
          # Start server in background (Windows style)
          start /B node server.js
          sleep 8
          
          # Test with PowerShell on Windows
          powershell -Command "try { Invoke-WebRequest -Uri 'http://localhost:8000' -UseBasicParsing | Out-Null; Write-Host 'âœ… Server responds correctly' } catch { Write-Host 'âŒ Server test failed'; exit 1 }"
          
          # Clean up Windows processes
          taskkill //F //IM node.exe 2>NUL || echo "Server cleanup attempted"
        else
          echo "ğŸ§ Testing on Unix-like system..."
          # Start server in background
          node server.js &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 5
          
          # Test if server is responding
          if command -v curl >/dev/null 2>&1; then
            echo "Testing server response..."
            curl -f http://localhost:8000 || exit 1
            echo "âœ… Server responds correctly"
          elif command -v wget >/dev/null 2>&1; then
            echo "Testing server response with wget..."
            wget --spider http://localhost:8000 || exit 1
            echo "âœ… Server responds correctly"
          else
            echo "âš ï¸ No curl or wget available, skipping HTTP test"
          fi
          
          # Clean up
          kill $SERVER_PID || true
        fi
        
    - name: ğŸ“š Validate Documentation
      run: |
        echo "ğŸ“– Testing documentation files..."
        
        # Check required docs exist
        test -f README.md || (echo "âŒ README.md missing" && exit 1)
        test -f LICENSE || (echo "âŒ LICENSE missing" && exit 1)
        test -f CONTRIBUTING.md || (echo "âŒ CONTRIBUTING.md missing" && exit 1)
        test -f CHANGELOG.md || (echo "âŒ CHANGELOG.md missing" && exit 1)
        
        # Check docs directory
        test -d docs || (echo "âŒ docs directory missing" && exit 1)
        
        # Validate markdown files don't have obvious syntax errors
        find docs -name "*.md" -exec head -1 {} \; > /dev/null
        
        echo "âœ… Documentation validation passed"

    - name: ğŸ”’ Security Check
      run: |
        echo "ğŸ” Running basic security checks..."
        
        # Check for common security issues
        echo "Checking for hardcoded secrets..."
        if grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.sh" . | grep -v "placeholder\|example\|TODO\|FIXME" | grep -E "(=|:)" ; then
          echo "âš ï¸ Potential hardcoded secrets found (review above)"
        else
          echo "âœ… No hardcoded secrets detected"
        fi
        
        # Check file permissions
        echo "Checking file permissions..."
        find . -name "*.sh" ! -perm -u+x -exec echo "âš ï¸ Script not executable: {}" \;
        
        echo "âœ… Security check completed"

    - name: ğŸ”§ Test Setup Process
      run: |
        echo "ğŸ› ï¸ Testing setup process..."
        
        # Validate setup script can run (dry run)
        if [[ "$RUNNER_OS" != "Windows" ]]; then
          # Test basic setup logic without actually running server
          bash -c "
            # Simulate the main parts of setup.sh
            echo 'ğŸ” Checking Node.js...'
            node --version
            echo 'ğŸ“ Checking project structure...'
            test -d web-wizard
            test -f web-wizard/server.js
            echo 'âœ… Setup validation completed'
          "
        else
          echo "âš ï¸ Skipping setup test on Windows"
        fi

  lint:
    name: ğŸ¨ Code Style & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: ğŸ§¹ Lint JavaScript
      run: |
        echo "ğŸ¨ Checking JavaScript code quality..."
        
        # Basic syntax validation
        find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
        
        echo "âœ… JavaScript syntax validation passed"

    - name: ğŸ” Check File Structure
      run: |
        echo "ğŸ“‚ Validating project structure..."
        
        # Required files
        required_files="README.md LICENSE CONTRIBUTING.md setup.sh web-wizard/server.js"
        
        for file in $required_files; do
          if [ ! -f "$file" ]; then
            echo "âŒ Required file missing: $file"
            exit 1
          fi
        done
        
        # Required directories
        required_dirs="docs web-wizard .github"
        
        for dir in $required_dirs; do
          if [ ! -d "$dir" ]; then
            echo "âŒ Required directory missing: $dir"
            exit 1
          fi
        done
        
        echo "âœ… Project structure validation passed"

  compatibility:
    name: ğŸŒ Cross-Platform Compatibility
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: ğŸ–¥ï¸ Test Platform Compatibility
      run: |
        echo "ğŸŒ Testing on ${{ runner.os }}..."
        
        # Test Node.js availability
        node --version
        npm --version
        
        # Test server file syntax
        cd web-wizard
        node -c server.js
        
        echo "âœ… Platform compatibility test passed on ${{ runner.os }}"

  status-check:
    name: âœ… All Tests Status
    runs-on: ubuntu-latest
    needs: [test, lint, compatibility]
    if: always()
    
    steps:
    - name: ğŸ“Š Check Results
      run: |
        echo "=== Test Results Summary ==="
        echo "Test: ${{ needs.test.result }}"
        echo "Lint: ${{ needs.lint.result }}"
        echo "Compatibility: ${{ needs.compatibility.result }}"
        
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.lint.result }}" == "success" && "${{ needs.compatibility.result }}" == "success" ]]; then
          echo "ğŸ‰ All tests passed! Ready for merge."
          exit 0
        else
          echo "âŒ Some tests failed. Please fix issues before merging."
          exit 1
        fi
